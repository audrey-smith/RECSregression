---
title: "Min et al."
author: "Audrey Smith"
date: "5/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(survey)
library(fastDummies)
library(sf)
```

```{r}
recs15 <- read.csv('RECS/recs2015_public_v4.csv')
#recs09 <- read.csv('RECS/recs2009_public.csv')
#recs05 <- read.csv('RECS/RECS05alldata.csv')

#Making dummy variables for some categorical vars
recs15 <- dummy_cols(recs15, select_columns = c('REGIONC', 'DIVISION', 'UATYP10', 'CLIMATE_REGION_PUB', 'IECC_CLIMATE_PUB',
                                                'TYPEHUQ', 'YEARMADERANGE', 'WALLTYPE', 
                                                'HOUSEHOLDER_RACE', 'HHSEX', 'KOWNRENT', 
                                                'FUELHEAT', 'FUELH2O',
                                                'ELPAY', 'NGPAY', 'LPGPAY', 'FOPAY',
                                                'WHEATSIZ', 'WASHTEMP')) %>%
          rename('CLIMATE_COLD'='CLIMATE_REGION_PUB_Cold/Very Cold', 'CLIMATE_HOTDRY'='CLIMATE_REGION_PUB_Hot-Dry/Mixed-Dry',
                 'CLIMATE_MARINE'='CLIMATE_REGION_PUB_Marine', 'CLIMATE_HOTHUMID'='CLIMATE_REGION_PUB_Hot-Humid', 'CLIMATE_MIXHUMID'='CLIMATE_REGION_PUB_Mixed-Humid', 
                 'IECC_CLIMATE_PUB_12A'='IECC_CLIMATE_PUB_1A-2A', 'IECC_CLIMATE_PUB_34B'='IECC_CLIMATE_PUB_3B-4B', 'IECC_CLIMATE_PUB_6AB'='IECC_CLIMATE_PUB_6A-6B',
                 'IECC_CLIMATE_PUB_78'='IECC_CLIMATE_PUB_7A-7B-7AK-8AK')

#Generating square terms
recs15$HDD65SQ <- recs15$HDD65^2
recs15$TOTROOMSSQ <- recs15$TOTROOMS^2
recs15$HSHLDSQ <- recs15$NHSLDMEM^2
recs15$EQUIPAGESQ <- recs15$EQUIPAGE^2
recs15$SPHCOSTSQ <- recs15$DOLELSPH^2

#Generating weight and rep weights
recsWeights <- recs15$NWEIGHT
recsBrr <- recs15[,grepl('^BRRWT', colnames(recs15))] #Grabbing all columns with Brr weights
recsBrrCol <- colnames(recsBrr) #Getting names of all columns containing Brr weights for later column selection

#Setting survey design
recsDes <- svrepdesign(weights = recsWeights, repweights = recsBrr, type = 'Fay', rho = .5, mse = TRUE, data = recs15) #Fay = resample method, Rho = weight shrinkage
```

_Re-Creating Min et al._
This section is just saved for reference. Was used to get familiarized with methods, the survey package, the RECS data, etc.

__Space Heating__
___Discrepancies / [Musings]:___
- year_built [Why no var for after 70s? - RECS has up 10 year intervals up to 2015]
- [Division may need to be re-worked for mountain south]
- fuelheat missing solar [Not an option on this year of RECS data]
- urban/rural [Unsure what they did with urban clusters. I have tentatively coded them as cities]
- concrete slab does not seem to be a variable on this data year
- [whether or not householder is black doesn't seem as relevant in our states]
```{r}
#Checking Distribution of Outcome Variable
ggplot(data = recs15) + geom_histogram(aes(x = TOTALBTUSPH)) +
  ggtitle('Total BTU Space Heating') + xlab('Thousand BTU per Year') + ylab('Count of Households') +
  theme(plot.title = element_text(hjust = .5))

ggplot(data = recs15) + geom_histogram(aes(x = log(TOTALBTUSPH+.00001))) +
  ggtitle('Natural Log of Total BTU Space Heating') + xlab('ln(Thousand BTU per Year + 0.00001)') + ylab('Count of Households') +
  theme(plot.title = element_text(hjust = .5))
```

```{r}
#Run model
minSHmodel <- svyglm(formula = log(TOTALBTUSPH+.00001) ~ as.factor(HEATHOME) + HHAGE + YEARMADERANGE_1 + YEARMADERANGE_2 + YEARMADERANGE_3 + YEARMADERANGE_4 + TOTSQFT_EN + HDD65 + HDD65SQ + MONEYPY + TYPEHUQ_5 + TEMPHOME + TEMPGONE + DIVISION_4 + DIVISION_3 + EQUIPAGESQ + FUELHEAT_3 + FUELHEAT_7 + FUELHEAT_5 + FUELHEAT_21 + WALLTYPE_1 + WALLTYPE_2 + UATYP10_R + HOUSEHOLDER_RACE_2 + WINDOWS + SPHCOSTSQ, design = recsDes, family = 'gaussian')

#Get model summary
R2 <- with(summary(minSHmodel), 1 - deviance/null.deviance)
print(paste0('R2:',R2))
summary(minSHmodel)
minSHmodel
```

__Water Heating__
___Musings/Discrepancies___
- [I question the validity of using the log. There is a lot more skewness in the log version of the response than there is in the non-transformed version]
- [Model fit is quite bad. Was much better for space heating. This makes sense to me because some of these variables don't seem particularly relevant (ex: why total number of rooms as opposed to number of bathrooms or types of kitchen facilities?)]
```{r}
#Checking Distribution of Outcome Variable
ggplot(data = recs15) + geom_histogram(aes(x = TOTALBTUWTH)) +
  ggtitle('Total BTU Water Heating') + xlab('Thousand BTU per Year') + ylab('Count of Households') +
  theme(plot.title = element_text(hjust = .5))

ggplot(data = recs15) + geom_histogram(aes(x = log(TOTALBTUWTH+.00001))) +
  ggtitle('Natural Log of Total BTU Water Heating') + xlab('ln(Thousand BTU per Year + 0.00001)') + ylab('Count of Households') +
  theme(plot.title = element_text(hjust = .5))
```

```{r}
#Run model
minWHmodel <- svyglm(formula = log(TOTALBTUWTH+.00001) ~ HHAGE + TOTROOMSSQ + DOLELWTH  + HOUSEHOLDER_RACE_2  + HDD65 + HDD65SQ + MONEYPY + NHSLDMEM + HSHLDSQ + WHEATSIZ_3 + FUELH2O_1 + FUELH2O_2 + FUELH2O_5 + DISHWASH + WASHTEMP_1 + WASHTEMP_2 + WASHTEMP_3, design = recsDes, family = 'gaussian')

R2WH <- with(summary(minWHmodel), 1 - deviance/null.deviance)
print(paste('R2:', R2WH, sep = ' '))
summary(minWHmodel)
minWHmodel
```