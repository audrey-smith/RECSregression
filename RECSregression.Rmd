---
title: "Energy Equity Residential Energy Consumption"
author: "Audrey Smith"
date: 5/8/2020"
output: html_document
---

_Setting up .rmd file_
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Librarying Packages
```{r}
library(tidyverse)
library(survey)
library(fastDummies)
library(sf)
```

#Reading in and Prepping Data
```{r}
#Reading in RECS data
recs15 <- read.csv('RECS/recs2015_public_v4.csv')

#Making dummy variables for some categorical vars
recs15 <- dummy_cols(recs15, select_columns = c('REGIONC', 'DIVISION', 'UATYP10', 'CLIMATE_REGION_PUB', 'IECC_CLIMATE_PUB',
                                                'TYPEHUQ', 'YEARMADERANGE', 'WALLTYPE', 
                                                'HOUSEHOLDER_RACE', 'HHSEX', 'KOWNRENT', 
                                                'FUELHEAT', 'FUELH2O',
                                                'ELPAY', 'NGPAY', 'LPGPAY', 'FOPAY',
                                                'WHEATSIZ', 'WASHTEMP')) %>%
          rename('CLIMATE_COLD'='CLIMATE_REGION_PUB_Cold/Very Cold', 'CLIMATE_HOTDRY'='CLIMATE_REGION_PUB_Hot-Dry/Mixed-Dry',
                 'CLIMATE_MARINE'='CLIMATE_REGION_PUB_Marine', 'CLIMATE_HOTHUMID'='CLIMATE_REGION_PUB_Hot-Humid', 'CLIMATE_MIXHUMID'='CLIMATE_REGION_PUB_Mixed-Humid', 
                 'IECC_CLIMATE_PUB_12A'='IECC_CLIMATE_PUB_1A-2A', 'IECC_CLIMATE_PUB_34B'='IECC_CLIMATE_PUB_3B-4B', 'IECC_CLIMATE_PUB_6AB'='IECC_CLIMATE_PUB_6A-6B',
                 'IECC_CLIMATE_PUB_78'='IECC_CLIMATE_PUB_7A-7B-7AK-8AK')

#Generating square terms
recs15$HDD65SQ <- recs15$HDD65^2
recs15$TOTROOMSSQ <- recs15$TOTROOMS^2
recs15$HSHLDSQ <- recs15$NHSLDMEM^2
recs15$EQUIPAGESQ <- recs15$EQUIPAGE^2
recs15$SPHCOSTSQ <- recs15$DOLELSPH^2

#Generating weight and rep weights
recsWeights <- recs15$NWEIGHT
recsBrr <- recs15[,grepl('^BRRWT', colnames(recs15))] #Grabbing all columns with Brr weights
recsBrrCol <- colnames(recsBrr) #Getting names of all columns containing Brr weights for later column selection

#Setting survey design
recsDes <- svrepdesign(weights = recsWeights, repweights = recsBrr, type = 'Fay', rho = .5, mse = TRUE, data = recs15) #Fay = resample method, Rho = weight shrinkage

recs15[1:5, 750:871]
```

#Template Regression
For use in model selection - just sub in appropriate response variable
fullModel <- svyglm(formula = log(BTUxxSPH +.00001) ~ xxWARM + xxPAY_1 + DIVISION_9 + CLIMATE_COLD + CLIMATE_MARINE + CLIMATE_HOTHUMID + CLIMATE_MIXHUMID + UATYP10_U + UATYP10_C+ TYPEHUQ + YEARMADERANGE + TOTROOMS + HOUSEHOLDER_RACE_2 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_4 + HOUSEHOLDER_RACE_5 + HOUSEHOLDER_RACE_7 + SDESCENT +  HHAGE + HHSEX_2 + EMPLOYHH + EDUCATION + MONEYPY + KOWNRENT_1, design = recsDes, subset = xx, family = 'gaussian')

#Space Heating
_Space Heating via Natural Gas_
```{r - Dummy Variable for NG}
heatNG_dum <- svyglm(formula = log(BTUNGSPH+.00001) ~ UGWARM + NGPAY_1 + DIVISION_9 + CLIMATE_COLD + CLIMATE_MARINE + CLIMATE_HOTHUMID + CLIMATE_MIXHUMID + UATYP10_U + UATYP10_C+ TYPEHUQ + YEARMADERANGE + TOTROOMS + HHAGE + EMPLOYHH, design = recsDes, family = 'gaussian')

heatNG_dum_R2 <- with(summary(heatNG_dum), 1 - deviance/null.deviance)
print(paste('The R2 for space heating via natural gas coded with a dummy variable is:', heatNG_dum_R2, sep = ' '))
summary(heatNG_dum)
heatNG_dum
```

```{r - Stratified to NG}
heatNG_strat <- svyglm(formula = log(BTUNGSPH) ~ CLIMATE_COLD + CLIMATE_MARINE + CLIMATE_HOTHUMID + CLIMATE_MIXHUMID + UATYP10_U + TYPEHUQ + YEARMADERANGE + TOTROOMS + HHAGE + EMPLOYHH + MONEYPY, design = recsDes, subset = c(UGWARM == 1), family = 'gaussian')

heatNG_strat_R2 <- with(summary(heatNG_strat), 1 - deviance/null.deviance)
print(paste0('The R2 for the stratified space heating via natural gas model is: ', heatNG_strat_R2))
summary(heatNG_strat)
heatNG_strat
```

_Space Heating via Propane/LPG_
```{r - Dummy Variable for LPG}
heatLPG_dum <- svyglm(formula = log(BTULPSPH+.00001) ~ LPWARM + LPGPAY_1 + DIVISION_9 + CLIMATE_MARINE + CLIMATE_HOTHUMID + UATYP10_U + UATYP10_C+ TYPEHUQ + YEARMADERANGE + TOTROOMS + HOUSEHOLDER_RACE_3, design = recsDes, family = 'gaussian')

heatLPG_dum_R2 <- with(summary(heatLPG_dum), 1-deviance/null.deviance)
print(paste('R2:', heatLPG_dum_R2, sep = ' '))
summary(heatLPG_dum)
heatLPG_dum
```

```{r - Stratified to LPG}
heatLPG_strat <- svyglm(formula = log(BTULPSPH) ~ DIVISION_9 + CLIMATE_COLD + CLIMATE_HOTHUMID + UATYP10_C+ YEARMADERANGE + TOTROOMS + HOUSEHOLDER_RACE_2 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_7 + SDESCENT, design = recsDes, subset = c(LPWARM == 1), family = 'gaussian')

heatLPG_strat_R2 <- with(summary(heatLPG_strat), 1 - deviance/null.deviance)
print(paste0('The R2 for the stratified LPG space heating model is: ', heatLPG_strat_R2))
summary(heatLPG_strat)
heatLPG_strat
```

_Space Heating via Fuel Oil/Kerosene_
```{r - Dummy Variable for FO}
heatFO_dum <- svyglm(formula = log(BTUFOSPH+.00001) ~ FOWARM + FOPAY_1 + CLIMATE_MIXHUMID + YEARMADERANGE + TOTROOMS + HOUSEHOLDER_RACE_7 + SDESCENT, design = recsDes, family = 'gaussian')

heatFO_dum_R2 <- with(summary(heatFO_dum), 1-deviance/null.deviance)
print(paste('The R2 for the dummy-coded fuel oil space heating model is:', heatFO_dum_R2, sep = ' '))
summary(heatFO_dum)
heatFO_dum
```

```{r - Stratified to FO}
heatFO_strat <- svyglm(formula = log(BTUFOSPH) ~ CLIMATE_COLD + CLIMATE_MARINE + CLIMATE_HOTHUMID + CLIMATE_MIXHUMID + UATYP10_U + TYPEHUQ + YEARMADERANGE + HOUSEHOLDER_RACE_7 + HHAGE + MONEYPY, design = recsDes, subset = c(FOWARM == 1), family = 'gaussian')

heatFO_strat_R2 <- with(summary(heatFO_strat), 1 - deviance/null.deviance)
print(paste0('The R2 for the stratified fuel oil space heating model is: ', heatFO_strat_R2))
summary(heatFO_strat)
heatFO_strat
```

_Space Heating via Wood_
```{r - Dummy Variable for Wood}
heatWood_dum <- svyglm(formula = log(WOODBTU + .00001) ~ WDWARM + UATYP10_U + YEARMADERANGE + HOUSEHOLDER_RACE_4 + HOUSEHOLDER_RACE_7, design = recsDes, family = 'gaussian')

heatWood_dum_R2 <- with(summary(heatWood_dum), 1-deviance/null.deviance)
print(paste('R2 for wood heating dummy model: ', heatWood_dum_R2))
summary(heatWood_dum)
heatWood_dum
```

```{r - Stratified to Wood}
heatWood_strat <- svyglm(formula = log(WOODBTU + 0.000001) ~ TYPEHUQ + YEARMADERANGE + HOUSEHOLDER_RACE_7, design = recsDes, subset = c(WDWARM == 1), family = 'gaussian')

print(paste0('R2 for stratified wood heating model is: ', with(summary(heatWood_strat), 1-deviance/null.deviance)))
summary(heatWood_strat)
heatWood_strat
```

_Space Heating - All Fuels_
```{r - All SPH Dummy}
warmTot_dum <- svyglm(formula = log(TOTALBTUSPH + .00001) ~ HEATHOME + ELPAY_1 + NGPAY_1 + FOPAY_1 + FUELHEAT_1 + FUELHEAT_2 + FUELHEAT_3 + FUELHEAT_5 + CLIMATE_COLD + CLIMATE_MARINE + CLIMATE_HOTHUMID + CLIMATE_MIXHUMID + UATYP10_U + TYPEHUQ + YEARMADERANGE + TOTROOMS + HOUSEHOLDER_RACE_2 + MONEYPY, design = recsDes, family = 'gaussian')

print(paste0('R2:', with(summary(warmTot_dum), 1-deviance/null.deviance)))
summary(warmTot_dum)
warmTot_dum
```

```{r - All SPH Stratified}
warmTot_strat <- svyglm(formula = TOTALBTUSPH ~ ELPAY_1 + NGPAY_1 + FOPAY_1 + FUELHEAT_1 + FUELHEAT_2 + FUELHEAT_3 + FUELHEAT_5 + CLIMATE_COLD + CLIMATE_MARINE + CLIMATE_HOTHUMID + CLIMATE_MIXHUMID + TYPEHUQ + YEARMADERANGE + TOTROOMS + HOUSEHOLDER_RACE_2 + HHAGE + MONEYPY, design = recsDes, subset = c(HEATHOME == 1), family = 'gaussian')

print(paste0('R2:', with(summary(warmTot_strat), 1-deviance/null.deviance)))
summary(warmTot_strat)
warmTot_strat
```

_Validating Data_
https://www.eia.gov/state/data.php?sid=CO#EnergyIndicators
CO: ~343 trillion BTU for residential uses in 2017
- 69% home heating NG, 23.2% elec, 4.7% LG, 3.0% none/other, 0.1% fuel oil

https://www.eia.gov/state/data.php?sid=NV#ConsumptionExpenditures
NV: ~165 trillion BTU for residential uses in 2017
- 57.3% home heating NG, 36.9% elec, 3.0% other/none, 2.3% LG, 0.5% fuel oil

https://www.eia.gov/state/data.php?sid=NM
NM: ~112 trillion BTU for residential use in 2017
- 63.1% home heating NG, 20.9% elec, 8.6% other/none, 7.2% LG, 0.1% fuel oil

```{r}
tractACS <- read_sf('predictors/ACS_climateZones_int.shp') %>%
  rename('popTot'='EstimatesT', 
         'white'='EstimatesW', 'black'='EstimatesB', 'amInd'='EstimatesA', 'asian'='Estimate_1', 'hiPI'='EstimatesN', 'other'='EstimatesS', 'multi'='EstimatesM',
         'medIncome'='EstimatesM', 
         'unitsTot'='Estimate_3', 'unitsOccupied'='EstimatesO', 'unitsVacant'='EstimatesV', 
         'rooms1'='Estimates1', 'rooms2'='Estimates2', 'rooms3'='Estimates3', 'rooms4'='Estimates4', 'rooms5'='Estimates5', 'rooms6'='Estimates6', 
         'rooms7'='Estimates7', 'rooms8'='Estimates8', 'rooms9plus'='Estimates9')
  
tractHDD <- read.csv('predictors/HDD_tractAvg.txt')
tractCDD <- read.csv('predictors/CDD_tractAvg.txt')
tractDD <- full_join(tractHDD, tractCDD, by = 'GISJOIN')

tractData <- full_join(tractACS, tractDD, by = 'GISJOIN')
```
























