---
title: "Energy Equity Residential Energy Consumption"
author: "Audrey Smith"
date: "4/29/2020"
output: html_document
---

_Setting up .rmd file_
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Installing and librarying packages - tidyverse for data cleaning and manipulation, survey for working with survey data
Survey documentation, including useful example can be found with command ??survey. Also described in context of RECS data in RECS technical documentation.
```{r}
#install.packages('tidyverse')
#install.packages('survey')
#install.packages('fastDummies')

library(tidyverse)
library(survey)
library(fastDummies)
```

_Reading in and Prepping Data_
Reading in 2015 RECS data along with accompanying data library. 
Library contains explanations of each variable, universe of responses, imputation codes, etc. Note that data library is incomplete here as it is not formatted in a .csv-friendly way. It is best viewed in the .xlsx file attached to the repo.
For a quick tutorial on how to work with this data set and the Survey package, see the read me document included in the Git Hub repo.
```{r}
recs15 <- read.csv('RECS/recs2015_public_v4.csv')
#recs09 <- read.csv('RECS/recs2009_public.csv')
#recs05 <- read.csv('RECS/RECS05alldata.csv')

#Making dummy variables for some categorical vars
recs15 <- dummy_cols(recs15, select_columns = c('REGIONC', 'DIVISION', 'UATYP10', 'CLIMATE_REGION_PUB', 'IECC_CLIMATE_PUB',
                                                'TYPEHUQ', 'YEARMADERANGE', 'WALLTYPE', 
                                                'HOUSEHOLDER_RACE', 'HHSEX', 'KOWNRENT', 
                                                'FUELHEAT', 'FUELH2O',
                                                'ELPAY', 'NGPAY', 'LPGPAY', 'FOPAY',
                                                'WHEATSIZ', 'WASHTEMP')) %>%
          rename('CLIMATE_COLD'='CLIMATE_REGION_PUB_Cold/Very Cold', 'CLIMATE_HOTDRY'='CLIMATE_REGION_PUB_Hot-Dry/Mixed-Dry', 'CLIMATE_MARINE'='CLIMATE_REGION_PUB_Marine',
                 'CLIMATE_HOTHUMID'='CLIMATE_REGION_PUB_Hot-Humid', 'CLIMATE_MIXHUMID'='CLIMATE_REGION_PUB_Mixed-Humid', 
                 'IECC_CLIMATE_PUB_12A'='IECC_CLIMATE_PUB_1A-2A', 'IECC_CLIMATE_PUB_34B'='IECC_CLIMATE_PUB_3B-4B', 'IECC_CLIMATE_PUB_6AB'='IECC_CLIMATE_PUB_6A-6B',
                 'IECC_CLIMATE_PUB_78'='IECC_CLIMATE_PUB_7A-7B-7AK-8AK')

#Generating square terms
recs15$HDD65SQ <- recs15$HDD65^2
recs15$TOTROOMSSQ <- recs15$TOTROOMS^2
recs15$HSHLDSQ <- recs15$NHSLDMEM^2
recs15$EQUIPAGESQ <- recs15$EQUIPAGE^2
recs15$SPHCOSTSQ <- recs15$DOLELSPH^2

#Generating weight and rep weights
recsWeights <- recs15$NWEIGHT
recsBrr <- recs15[,grepl('^BRRWT', colnames(recs15))] #Grabbing all columns with Brr weights
recsBrrCol <- colnames(recsBrr) #Getting names of all columns containing Brr weights for later column selection

#Setting survey design
recsDes <- svrepdesign(weights = recsWeights, repweights = recsBrr, type = 'Fay', rho = .5, mse = TRUE, data = recs15) #Fay = resample method, Rho = weight shrinkage
```

_Creating our Own Regression_
Starting by seeing how strong a fit we can get with variables included in both RECS and ACS in interest of confining number of regressions needed for prediction. 
List of variables included in both datasets or with a proxy in one dataset that can be used for the other + (name in RECS):
___Geo___
- Census region (REGIONC: 1 Northeast, 2 Midwest, 3 South, 4 West)
- Census division (DIVISION: 1 New Eng, 2 Mid Atlantic, 3 E N Central, 4 W N Central, 5 South Atlantic, 6 E S CEntral 7 W S Central, 8 Mtn N, 9 Mtn S, 10 Pacific)
- Urban or rural (UATYP10: U Urban, C Urban Cluster, R Rural)
- Building America climate zone (CLIMATE_REGION_PUB: Cold/Very Cold, Hot-Dry/Mixed-Dry, Hot-Humid, Mixed-Humid, Marine)
- IECC climate zone (IECC_CLIMATE_PUB: 1A-2A, 2B, 3A, 3B-4B, 3C, 4A, 4C, 5A, 5B-5C, 6A-6B, 7A-7B-7AK-8AK)
- # heating degree days base 65 (HDD65), cooling degree days (CDD65)

___Building___
- # housing units in building (TYPEHUQ: 1 mobile home, 2 single family detached, 3 single family attached, 4 apt 2-4 units, 5 apt 5+ units)
- Owner or renter occupied unit (KOWNRENT: 1 owner occupied, 2 renter occupied, 3 occuppied wo rent [squatter occupied??])
- Year housing built (YEARMADERANGE: 1 before 1950, 2 50s, 3 60s, 4 70s, 5 80s, 6 90s, 7 00s, 8 2010-2015)
- # bedrooms in housing unit (BEDROOMS: #0-30), # full bathrooms in housing unit (NCOMBATH: #0-30), # rooms in housing unit other than bathrooms (TOTROOMS: #0-60)
- Internet access at home (INTERNET: 1 Yes, 0 No)
- # computers at home (DESKTOP: #0-30, LAPTOP: #0-30)

___Demo___
- Householder race (HOUSEHOLDER_RACE: 1 white, 2 black, 3 Native American, 4 Asian, 5 Pacific Islander, 6 other, 7 multi), 
- Householder ethnicity (SDESCENT: 1 HL, 0 not HL) 
- Householder sex (HHSEX: 1 female, 2 male)
- Householder age (HHAGE: #18-110)
- Householder employment status (EMPLOYHH: 1 fulltime, 2 parttime, 3 unemployed or retired)
- Householder education level (EDUCATION: 1 less HS, 2 HS, 3 some college or associates, 4 BA/BS, 5 post-grad)
- Household income (MONEYPY: 1 <20K, 2 20-39K, 3 40-59K, 4 60-79K, 5 80-99K, 6 100-119K, 7 120-139K, 8 >140K)
- # adults in household (NUMADULT: #1-20), # children in household (NUMCHILD: #1-20), # people in household (NSHLDMEM: #1-20)
- # weekdays someone home (ATHOME: #0-5) - (weak?) proxy would be telecommute in ACS

___Util___
- Who pays for electricity (ELPAY), natural gas (NGPAY), liquid propane/gas (LPGPAY), fuel oil (FOPAY) (1 household, 2 landlord, 3 shared, 9 other, -2 NA [no -2 for ELPAY])
- Unit heated (HEATHOME: 1 Yes, 0 No) - equivalent in ACS is the heating fuel variable, for which there is one category for "no fuel used" 
- What fuel is used for space heating (FUELHEAT: 1 natural gas, 2 propane, 3 fuel oil/kerosene, 5 electricity, 7 wood, 21 other, -2 NA)
- Can code proxy variable for presence of complete kitchen facilities by combinining some of the more specific kitchen vars (ex: FULLKITCHEN = ifelse(STOVE > 1 & OVEN > 1, 1, 0))
Only space heating portion available in ACS:
- Electricity used (USELE) for space heating (ELWARM), water heating (ELWATER), cooking (ELFOOD) (1 yes, 0 no)
- Natural gas used (USENG) for space heating (UGWARM), water heating (UGWATER), cooking (UGCOOK), other purposes (UGOTH) (1 yes, 0 no)
- Fuel oil used (USEFO) for space heating (FOWARM), water heating (FOWATER), other purposes (FOOTHER) (1 yes, 0 no)
- Liquid propane used (USELP) for space heating (LPWARM), water heating (LPWATER), cooking (LPCOOK), other purposes (LPOTHER) (1 yes, 0 no)
- Wood used (USEWOOD) for space heating (WDWARM), water heating (WDWATER), other purposes (WDOTHER) (1 yes, 0 no)
- Solar used (USESOLAR) for water heating (SOLWATER), other purposes (SOLOTHER) (1 yes, 0 no)

__Outcomes___
- Natural Gas: total (CUFEETNG, BTUNG), space heating (CUFEETNGSPH, BTUNGSPH), water heating (CUFEETNGWTH, BTUNGWTH), cooking (CUFEETNGCOK, BTUNGCOK)
- Electricity: total (KWH, BTUEL), space heating (KWHSPH, BTUELSPH), AC (KWHCOL, BTUELCOL), water heating (KWHWTH, BTUELWTH), kitchen contains vars for many appliances
- Propane: total (GALLONLP, BTULP) space heating (GALLONLPSPH, BTULPSPH), waterheating (GALLONLPWTH, BTULPWTH), cooking (GALLONLPCOK, BTULPCOK)
- Fuel oil: total (GALLONFO, BTUFO), space heating (GALLONFOSPH, BTUFOSPH), water heating (GALLONFOWTH, BTUFOWTH)
- Wood: total cords (WOODAMT), total BTU (WOODBTU)
- If needed for validation, there are variables detailing the cost of each of these other variables

### NOTE:
If we can't get strong enough model fit with ACS alone, the AHS looks promising and contains many variables also contained in RECS. I would need to read up a bit on methodologies for combining data from more than one survey but this would potentially improve fit and eliminate need for sub-regressions for independent variables. Contains vars such as floors in unit, foundation type, cookstove use, solar panels, etc. Geography goes down to Census Tract level.

## ALSO NOTE:
To re-run prioritizing inclusion of categories where variety exists within our states, as well as with a stratified sample of just Mountain/Mountain South.
```{r}
recs15[1:5, 740:820]
```

#For use in model selection - just sub in appropriate response variable
fullModel <- svyglm(formula = log(BTUNGSPH+.00001) ~ ELWARM + CLIMATE_COLD + CLIMATE_MARINE + CLIMATE_HOTHUMID + CLIMATE_MIXHUMID + IECC_CLIMATE_PUB_12A + IECC_CLIMATE_PUB_6AB + IECC_CLIMATE_PUB_78 + HDD65 + DIVISION_1 + DIVISION_2 + DIVISION_3 + DIVISION_4 + DIVISION_5 + DIVISION_6 + DIVISION_7 + DIVISION_8 + DIVISION_10 + UATYP10_U + UATYP10_C+ TYPEHUQ + YEARMADERANGE + TOTROOMS + HOUSEHOLDER_RACE_2 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_4 + HOUSEHOLDER_RACE_5 + HOUSEHOLDER_RACE_7 + SDESCENT + HHSEX_2 + EMPLOYHH + EDUCATION + MONEYPY + KOWNRENT_1 + ELPAY_1, design = recsDes, family = 'gaussian')

__Space Heating by Fuel Type__
Reference groups in dummy vars: DIVISION_9 (Mountain South), UATYP10_R (rural areas), HOUSEHOLDER_RACE_1 (white only [also 6/other missing from dummy var?]), HHSEX_2 (male), KOWNRENT_1 (owner occupied), ELPAY_1 (respondent pays electric), CLIMATE_HOTDRY (marine climate zone - unsure what to use here since our study area isn't all within one climate zone), IECC_CLIMATE_PUB_3A (similar to hot/dry in other climate var)
Variables to test as nominal, ordinal, or numeric: TYPEHUQ (preliminary test indicates numeric best fit), YEARMADERANGE, EMPLOYHH, EDUCATION, MONEYPY
```{r}
#Space heating - natural gas
#ggplot(acsRECS) + geom_histogram(aes(x = CUFEETNGSPH))
#ggplot(acsRECS) + geom_histogram(aes(x = log(CUFEETNGSPH+0.00001)))

acsModel_heatNG <- svyglm(formula = log(BTUNGSPH+.00001) ~ UGWARM + CLIMATE_COLD + CLIMATE_MARINE + CLIMATE_HOTHUMID + CLIMATE_MIXHUMID + IECC_CLIMATE_PUB_6AB + IECC_CLIMATE_PUB_78 + HDD65 + UATYP10_U + UATYP10_C+ TYPEHUQ + YEARMADERANGE + TOTROOMS + NGPAY_1, design = recsDes, family = 'gaussian')

R2 <- with(summary(acsModel_heatNG), 1 - deviance/null.deviance)
print(paste('R2:', R2, sep = ' '))
summary(acsModel_heatNG)
acsModel_heatNG
```

```{r}
#Space heating - propane/LPG

```

```{r}
#Space heating - fuel oil/kerosene

```

```{r}
#Space heating - wood

```

_Re-Creating Min et al._
__Space Heating__
___Discrepancies / [Musings]:___
- year_built [Why no var for after 70s? - RECS has up 10 year intervals up to 2015]
- [Division may need to be re-worked for mountain south]
- fuelheat missing solar [Not an option on this year of RECS data]
- urban/rural [Unsure what they did with urban clusters. I have tentatively coded them as cities]
- concrete slab does not seem to be a variable on this data year
- [whether or not householder is black doesn't seem as relevant in our states]
```{r}
#Checking Distribution of Outcome Variable
ggplot(data = recs15) + geom_histogram(aes(x = TOTALBTUSPH)) +
  ggtitle('Total BTU Space Heating') + xlab('Thousand BTU per Year') + ylab('Count of Households') +
  theme(plot.title = element_text(hjust = .5))

ggplot(data = recs15) + geom_histogram(aes(x = log(TOTALBTUSPH+.00001))) +
  ggtitle('Natural Log of Total BTU Space Heating') + xlab('ln(Thousand BTU per Year + 0.00001)') + ylab('Count of Households') +
  theme(plot.title = element_text(hjust = .5))
```

```{r}
#Run model
minSHmodel <- svyglm(formula = log(TOTALBTUSPH+.00001) ~ as.factor(HEATHOME) + HHAGE + YEARMADERANGE_1 + YEARMADERANGE_2 + YEARMADERANGE_3 + YEARMADERANGE_4 + TOTSQFT_EN + HDD65 + HDD65SQ + MONEYPY + TYPEHUQ_5 + TEMPHOME + TEMPGONE + DIVISION_4 + DIVISION_3 + EQUIPAGESQ + FUELHEAT_3 + FUELHEAT_7 + FUELHEAT_5 + FUELHEAT_21 + WALLTYPE_1 + WALLTYPE_2 + UATYP10_R + HOUSEHOLDER_RACE_2 + WINDOWS + SPHCOSTSQ, design = recsDes, family = 'gaussian')

#Get model summary
R2 <- with(summary(minSHmodel), 1 - deviance/null.deviance)
print(paste0('R2:',R2))
summary(minSHmodel)
minSHmodel
```

__Water Heating__
___Musings/Discrepancies___
- [I question the validity of using the log. There is a lot more skewness in the log version of the response than there is in the non-transformed version]
- [Model fit is quite bad. Was much better for space heating. This makes sense to me because some of these variables don't seem particularly relevant (ex: why total number of rooms as opposed to number of bathrooms or types of kitchen facilities?)]
```{r}
#Checking Distribution of Outcome Variable
ggplot(data = recs15) + geom_histogram(aes(x = TOTALBTUWTH)) +
  ggtitle('Total BTU Water Heating') + xlab('Thousand BTU per Year') + ylab('Count of Households') +
  theme(plot.title = element_text(hjust = .5))

ggplot(data = recs15) + geom_histogram(aes(x = log(TOTALBTUWTH+.00001))) +
  ggtitle('Natural Log of Total BTU Water Heating') + xlab('ln(Thousand BTU per Year + 0.00001)') + ylab('Count of Households') +
  theme(plot.title = element_text(hjust = .5))
```

```{r}
#Run model
minWHmodel <- svyglm(formula = log(TOTALBTUWTH+.00001) ~ HHAGE + TOTROOMSSQ + DOLELWTH  + HOUSEHOLDER_RACE_2  + HDD65 + HDD65SQ + MONEYPY + NHSLDMEM + HSHLDSQ + WHEATSIZ_3 + FUELH2O_1 + FUELH2O_2 + FUELH2O_5 + DISHWASH + WASHTEMP_1 + WASHTEMP_2 + WASHTEMP_3, design = recsDes, family = 'gaussian')

R2WH <- with(summary(minWHmodel), 1 - deviance/null.deviance)
print(paste('R2:', R2WH, sep = ' '))
summary(minWHmodel)
minWHmodel
```

























