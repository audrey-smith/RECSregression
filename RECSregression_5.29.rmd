---
title: "Energy Equity Residential Energy Consumption"
author: "Audrey Smith"
date: 5/8/2020"
output: html_document
---

_Setting up .rmd file_
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Librarying Packages
```{r}
library(tidyverse)
library(survey)
library(fastDummies)
library(sf)
library(data.table)
library(MASS)
options(scipen=999)
```

#Read in Data
Note - there's a big mismatch between what I've hand-calculated as electricity and NG price based on the RECS data and the prices downloaded from the EIA site. I'm fairly certain they are the same units - so unsure what the source of the discrepancy is.
```{r - Read RECS data and set study design}
#Reading in RECS data
recs15 <- read.csv('RECS/recs2015_mountain_clean.csv')
recs15_usa <- read.csv('RECS/recs2015_public_clean.csv')

#Calculate energy prices
recs15$PRNG <- 10*recs15$DOLLARNG/recs15$CUFEETNG #EIA price is per 1,000 cu ft, this is in 100 cu ft
recs15$PREL <- 100*recs15$DOLLAREL/recs15$KWH #100 is arbitrary and from visually inspecting the data - need to inspect discrepancy
recs15$PRLPG <- recs15$DOLLARLP/(recs15$BTULP/1000)
recs15$PRFO <- recs15$DOLLARFO/(recs15$GALLONFO/1000)

#Generating weight and rep weights
recsWeights <- recs15$NWEIGHT
recsBrr <- recs15[,grepl('^BRRWT', colnames(recs15))] #Grabbing all columns with Brr weights

generateDes <- function(recs15FUEL){
  recsWeights <- subset(recs15, recs15FUEL > 0) %>% pull(NWEIGHT)
  colsBrr <- subset(colnames(recs15), grepl('^BRRWT', colnames(recs15)) == T)
  recsBrr <- filter(recs15, recs15FUEL > 0) %>% dplyr::select(colsBrr)
  
  recsDes <- svrepdesign(weights = recsWeights, repweights = recsBrr, type = 'Fay', rho = .5, mse = TRUE, data = subset(recs15, recs15FUEL > 0))
  
  return(recsDes)
}

#Setting survey design
recsDes <- svrepdesign(weights = recsWeights, repweights = recsBrr, type = 'Fay', rho = .5, mse = TRUE, data = recs15) 
recsDes_EL <- generateDes(recs15$KWH)
recsDes_NG <- generateDes(recs15$CUFEETNG)
#recsDes_FO <- generateDes_USA(recs15$GALLONFO)
recsDes_WD <- generateDes(recs15$WOODAMT)

LPGweights <- subset(recs15, GALLONLP > 0) %>% pull(NWEIGHT)
colsBrr <- subset(colnames(recs15), grepl('^BRRWT', colnames(recs15)) == T)
LPGBrr <- filter(recs15, GALLONLP > 0) %>% dplyr::select(colsBrr)
recsDes_LPG <- svrepdesign(weights = LPGweights, repweights = LPGBrr, type = 'Fay', rho = .5, mse = TRUE, data = subset(recs15, GALLONLP > 0))
```

```{r - Read in ACS Data}
tractPreds <- read.csv('predictors/ACSclimate_clean.csv') %>% dplyr::select(-c(X, MONEYPY, YEARMADERANGE)) %>% filter(TOTALPOP != 0) %>% filter(TOTALHH != 0)
tractGeom <- read_sf('predictors/ACS_climateZones_int.shp') %>% dplyr::select(GISJOIN, geometry)

#Need to figure out why so many NAs
tractPreds <- drop_na(tractPreds)

#Add energy prices from EIA
tractPreds$PRNG <- ifelse(tractPreds$state_code == 8, 7.72, ifelse(tractPreds$state_code == 32, 7.89, 9.24))
tractPreds$PREL <- ifelse(tractPreds$state_code == 8, 12.04, ifelse(tractPreds$state_code == 32, 12.47, 12.12))
tractPreds$PRLPG <- ifelse(tractPreds$state_code == 8, 23.03, ifelse(tractPreds$state_code == 32, 29.97, 26.07))
tractPreds$PRFO <- ifelse(tractPreds$state_code == 8, 17.23, ifelse(tractPreds$state_code == 32, 19.17, 15.51))
```

#Plotting Response Variables
```{r}
#Electricity
svyhist(~KWH, recsDes)
svyhist(~log(KWH+.0000001), recsDes)
svyhist(~sqrt(KWH), recsDes)

#Natural Gas
svyhist(~CUFEETNG, recsDes)
svyhist(~log(CUFEETNG+.000001), recsDes)
svyhist(~sqrt(CUFEETNG), recsDes)

#Liquid Propane
svyhist(~GALLONLP, recsDes)
svyhist(~log(GALLONLP+.0000001), recsDes)
svyhist(~sqrt(GALLONLP), recsDes)

#Fuel Oil
svyhist(~GALLONFO, recsDes)
svyhist(~log(GALLONFO + .0000001), recsDes)
svyhist(~sqrt(GALLONFO), recsDes)

#Wood
svyhist(~WOODAMT, recsDes)
svyhist(~log(WOODAMT + .0000001), recsDes)
svyhist(~sqrt(WOODAMT), recsDes)
```

lpgLog_full <- svyglm(log(BTULP+.0000000001) ~ DIVISION_8 + CLIMATE_HOTDRY + HDD65 + CDD65 + HHAGE + HHSEX_1 + log(NHSLDMEM) + NUMCHILD + HDD65 + CDD65 + HHAGE + HHSEX_1 + log(NHSLDMEM) + NUMCHILD + TOTROOMS + TOTROOMSSQ + FUELHEAT_1 + FUELHEAT_2 + FUELHEAT_5+ EMPLOYHH_12 + SDESCENT_1 + MONEYPY_2 + MONEYPY_3 + MONEYPY_45 + MONEYPY_678 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_4 + YEARMADERANGE_2 + YEARMADERANGE_3 + YEARMADERANGE_4 + YEARMADERANGE_5 + YEARMADERANGE_6 + YEARMADERANGE_7, family = gaussian(identity), design = recsDes_LPG)

## Log Models by Fuel Type
```{r}
### ELECTRICITY ###
#Full
elecLog_full <- svyglm(log(BTUEL+.0000000001) ~ DIVISION_8 + CLIMATE_HOTDRY + FUELHEAT_1 + FUELHEAT_2 + FUELHEAT_5 + FUELHEAT_7 + PREL + HDD65 + CDD65 + HHAGE + HHSEX_1 + log(NHSLDMEM) + NUMCHILD + EMPLOYHH_12 + SDESCENT_1 + MONEYPY_2 + MONEYPY_3 + MONEYPY_45 + MONEYPY_678 + HOUSEHOLDER_RACE_2 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_4 + HOUSEHOLDER_RACE_5 + HOUSEHOLDER_RACE_7 + TOTROOMS + TOTROOMSSQ + YEARMADERANGE_2 + YEARMADERANGE_3 + YEARMADERANGE_4 + YEARMADERANGE_5 + YEARMADERANGE_6 + YEARMADERANGE_7 + YEARMADERANGE_8 + TYPEHUQ_1 + TYPEHUQ_3 + TYPEHUQ_4 + TYPEHUQ_5 + ELPAY_1 + HEATHOME, family = gaussian(identity), design = recsDes_EL)

#Select
elecLog <- stepAIC(object = elecLog_full, direction = 'backward', trace = F)
elecLog_MSE <- c(crossprod(elecLog$residuals))/length(elecLog$residuals)

#Predict
predict_elecLog <- as.data.frame(predict(object = elecLog, newdata = tractPreds, type = 'response', na.action = na.include))
predict_elecLog$BTUelec <- 1000*exp(elecLog_MSE/2)*exp(predict_elecLog$response)
```

```{r}
### NATURAL GAS ###
#Full
ngLog_full <- svyglm(log(BTUNG+.0000000001) ~ DIVISION_8 + CLIMATE_HOTDRY + FUELHEAT_1 + FUELHEAT_2 + FUELHEAT_5 + FUELHEAT_7 + PRNG + HDD65 + CDD65 + HHAGE + HHSEX_1 + log(NHSLDMEM) + NUMCHILD + EMPLOYHH_12 + SDESCENT_1 + MONEYPY_2 + MONEYPY_3 + MONEYPY_45 + MONEYPY_678 + TOTROOMS + TOTROOMSSQ + YEARMADERANGE_2 + YEARMADERANGE_3 + YEARMADERANGE_4 + YEARMADERANGE_5 + YEARMADERANGE_6 + YEARMADERANGE_7 + YEARMADERANGE_8+ TYPEHUQ_1 + TYPEHUQ_3 + TYPEHUQ_4 + TYPEHUQ_5 + HOUSEHOLDER_RACE_2 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_4 + HOUSEHOLDER_RACE_5 + ELPAY_1, family = gaussian(identity), design = recsDes_NG)

#Log
ngLog <- stepAIC(object = ngLog_full, direction = 'backward', trace = F)
ngLog_MSE <- c(crossprod(ngLog$residuals))/length(ngLog$residuals)

#Predict
predict_ngLog <- as.data.frame(predict(object = ngLog, newdata = tractPreds, type = 'response', na.action = na.exclude))
predict_ngLog$BTUng <- 1000*exp(ngLog_MSE/2)*exp(predict_ngLog$response)
```

```{r}
### LIQUID PROPANE GAS ###
#Full
lpgLog_full <- svyglm(log(BTULP+.0000000001) ~ DIVISION_8 + CLIMATE_HOTDRY + PRLPG + FUELHEAT_1 + FUELHEAT_2 + FUELHEAT_5 + HDD65 + CDD65 + HHAGE + HHSEX_1 + log(NHSLDMEM) + NUMCHILD + EMPLOYHH_12 + SDESCENT_1 + MONEYPY_2 + MONEYPY_3 + MONEYPY_45 + MONEYPY_678 + TOTROOMS + TOTROOMSSQ + YEARMADERANGE_2 + YEARMADERANGE_3 + YEARMADERANGE_4 + YEARMADERANGE_5 + YEARMADERANGE_6 + YEARMADERANGE_7 + TYPEHUQ_1 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_4, family = gaussian(identity), design = recsDes_LPG)

#Log
lpgLog <- stepAIC(object = lpgLog_full, direction = 'backward', trace = F)
lpgLog_MSE <- c(crossprod(lpgLog$residuals))/length(lpgLog$residuals)

#Predict
predict_lpgLog <- as.data.frame(predict(object = lpgLog, newdata = tractPreds, type = 'response', na.action = na.exclude))
predict_lpgLog$BTUlpg <- 1000*exp(lpgLog_MSE/2)*exp(predict_lpgLog$response)
```

```{r}
### FUEL OIL ###
#Full
foLog_full <- svyglm(log(BTUFO+.0000000001) ~ DIVISION_8 + CLIMATE_HOTDRY + FUELHEAT_1 + FUELHEAT_2 + FUELHEAT_5 + FUELHEAT_7 + HDD65 + CDD65 + HHAGE + HHSEX_1 + log(NHSLDMEM) + NUMCHILD + EMPLOYHH_12 + SDESCENT_1 + MONEYPY_2 + MONEYPY_3 + MONEYPY_45 + MONEYPY_678 + HOUSEHOLDER_RACE_2 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_4 + HOUSEHOLDER_RACE_5 + HOUSEHOLDER_RACE_7 + TOTROOMS + TOTROOMSSQ + YEARMADERANGE_2 + YEARMADERANGE_3 + YEARMADERANGE_4 + YEARMADERANGE_5 + YEARMADERANGE_6 + YEARMADERANGE_7 + YEARMADERANGE_8 + TYPEHUQ_1 + TYPEHUQ_3 + TYPEHUQ_4 + TYPEHUQ_5 + ELPAY_1 + HEATHOME, family = gaussian(identity), design = recsDes)

#Log
foLog <- stepAIC(object = foLog_full, direction = 'backward', trace = F)
foLog_MSE <- c(crossprod(foLog$residuals))/length(foLog$residuals)

#Predict
predict_foLog <- as.data.frame(predict(object = foLog, newdata = tractPreds, type = 'response', na.action = na.exclude))
predict_foLog$BTUfo <- 1000*exp(predict_foLog$response)
```

```{r}
### WOOD ###
#Full
woodLog_full <- svyglm(log(WOODBTU+.0000000001) ~ DIVISION_8 + CLIMATE_HOTDRY + FUELHEAT_1 + FUELHEAT_2 + FUELHEAT_5 + FUELHEAT_7 + HDD65 + CDD65 + HHAGE + HHSEX_1 + log(NHSLDMEM) + NUMCHILD + EMPLOYHH_12 + SDESCENT_1 + MONEYPY_2 + MONEYPY_3 + MONEYPY_45 + MONEYPY_678 + HOUSEHOLDER_RACE_2 + HOUSEHOLDER_RACE_3 + HOUSEHOLDER_RACE_4 + HOUSEHOLDER_RACE_5 + HOUSEHOLDER_RACE_7 + TOTROOMS + TOTROOMSSQ + YEARMADERANGE_2 + YEARMADERANGE_3 + YEARMADERANGE_4 + YEARMADERANGE_5 + YEARMADERANGE_6 + YEARMADERANGE_7 + YEARMADERANGE_8 + TYPEHUQ_1 + TYPEHUQ_3 + TYPEHUQ_4 + TYPEHUQ_5 + ELPAY_1 + HEATHOME, family = gaussian(identity), design = recsDes)

#Log
woodLog <- stepAIC(object = woodLog_full, direction = 'backward', trace = F)
woodLog_MSE <- c(crossprod(woodLog$residuals))/length(woodLog$residuals)

#Predict
predict_woodLog <- as.data.frame(predict(object = woodLog, newdata = tractPreds, type = 'response', na.action = na.exclude))
predict_woodLog$BTUwood <- 1000*exp(predict_woodLog$response)
```

_All Fuels_
```{r}
predict_allLog <- as.data.frame(cbind(tractPreds[,c(1, 14, 19, 18)], predict_elecLog, predict_ngLog, predict_lpgLog, predict_foLog, predict_woodLog))
predict_allLog <- predict_allLog[, c(1:4, 7, 10, 13, 16, 19)]
expected <- c(343000000000000, 165000000000000, 112000000000000)

#Check Against EIA
predict_allLog %>%
  mutate(county_code = str_sub(GISJOIN, 4, 7)) %>%
  group_by(state_code, county_code) %>%
  summarize(elec = mean(BTUelec), ng = mean(BTUng), lpg = mean(BTUelec), wood = mean(BTUwood)) %>%
  ggplot() + geom_boxplot(aes(x = factor(state_code), y = lpg))
```

```{r}
predict_allLog %>%
  filter(state_code == 35) %>%
  summarize(kWh = mean(BTUelec/3412), cf = mean(BTUng/1015), gallonLPG = mean(BTUlpg/91,502))
```

```{r}
predict_allLog %>%
  mutate(KWHelec = BTUelec/3412, CFng = BTUng/1015, GALlpg = BTUlpg/91502) %>%
  write.csv('output/output_May31.csv')
```

http://www.swenergy.org/Data/Sites/1/media/documents/publications/factsheets/nv-factsheet.pdf
https://www.eia.gov/state/data.php?sid=CO#EnergyIndicators
CO: ~343 trillion BTU for residential uses in 2017
- 69% home heating NG, 23.2% elec, 4.7% LG, 3.0% none/other, 0.1% fuel oil

https://www.eia.gov/state/data.php?sid=NV#ConsumptionExpenditures
NV: ~165 trillion BTU for residential uses in 2017
- 57.3% home heating NG, 36.9% elec, 3.0% other/none, 2.3% LG, 0.5% fuel oil

https://www.eia.gov/state/data.php?sid=NM
NM: ~112 trillion BTU for residential use in 2017
- 63.1% home heating NG, 20.9% elec, 8.6% other/none, 7.2% LG, 0.1% fuel oil